var luckyLottery={init:function(){luckyLottery.registerHelper(),luckyLottery.getCjMemberResultList(),luckyLottery.imgChange(),luckyLottery.runNews(),common.saveWeixinInfoToUser(window.location.href),luckyLottery.author(),luckyLottery.bind()},options:{signature:null,timestamp:null,nonceStr:null,appid:null,canLottery:!0},enterWxAuthor:function(){var e=localStorage.getItem("wxUserInfo");if(e)luckyLottery.init();else{var t=common.getUrlParameter("code");t?(common.getWxUserInfo(t),luckyLottery.init()):window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WX_APPID+"&redirect_uri="+window.location.href+"&response_type=code&scope=snsapi_userinfo#wechat_redirect"}},runNews:function(){function e(){0==n?(t.eq(n).show(),n++):n==o?(t.eq(0).show(),n=1):(t.eq(n).show(),t.eq(n-1).hide(),n++)}var t=$(".ad ul li"),o=t.length,n=0;e(),setInterval(e,4e3)},imgChange:function(){setInterval(function(){var e="http://www.szqhflkj.cn/weixin/static/img/flag2.png",t=$(".flag img").attr("src");t==e?$(".flag img").attr("src",WX_STATIC+"img/flag1.png"):$(".flag img").attr("src",WX_STATIC+"img/flag2.png")},300)},registerHelper:function(){Handlebars.registerHelper("time",function(e,t){return new Date(parseInt(e)).toLocaleString().replace(/:\d{1,2}$/," ")}),Handlebars.registerHelper("nickname",function(e,t){return""==e||null==e?"--":e}),Handlebars.registerHelper("compare",function(e,t,o,n){if(arguments.length<3)throw new Error('Handlerbars Helper "compare" needs 2 parameters');var r={"==":function(e,t){return e==t},"===":function(e,t){return e===t},"!=":function(e,t){return e!=t},"!==":function(e,t){return e!==t},"<":function(e,t){return e<t},">":function(e,t){return e>t},"<=":function(e,t){return e<=t},">=":function(e,t){return e>=t},typeof:function(e,t){return typeof e==t}};if(!r[t])throw new Error('Handlerbars Helper "compare" doesn\'t know the operator '+t);var i=r[t](e,o);return i?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("headImg",function(e,t){return""==e||null==e?"http://www.szqhflkj.cn/weixin/static/img/logo.png":e}),Handlebars.registerHelper("date",function(e,t){return e.substr(5,11)})},lottery:function(e){luckyLottery.options.canLottery&&(luckyLottery.options.canLottery=!1,common.tips({msg:"活动已结束！",stayTime:4e3}))},initMemberEventLotteryNum:function(){var e=localStorage.getItem("token");e?$.ajax({type:"POST",url:WX_ROOT+"usercenter/queryUserLeftLotteryCount",dataType:"json",data:{token:localStorage.getItem("token")},cache:!1,success:function(e){var t=JSON.parse(e).detail;$(".lotteryNum").text(+-+t),0==t?$(".myRecordDiv p:nth-of-type(1)").html("您的抽奖机会已用完，赶紧去邀请好友注册赢得新的抽奖机会吧"):$(".myRecordDiv p:nth-of-type(1)").html('当前还剩余<span class="lotteryNum">'+t+"</span>次抽奖机会")}}):$(".myRecordDiv p:nth-of-type(1)").html("请先登录！！")},getCjMemberResultList:function(e){var e=e||1,t=10;$.ajax({type:"post",url:WX_ROOT+"usercenter/queryCjResult",data:{pageNumber:e,pageSize:t},success:function(e,t){var o=Handlebars.compile($("#winListDiv").html()),n=Handlebars.compile($("#adListDiv").html());$(".ad ul").html(n(JSON.parse(e).detail.list)),$(".listDiv").html(o(JSON.parse(e).detail.list))}})},author:function(){var e,t=window.location.href.split("#")[0];luckyLottery.options.signature||$.ajax({async:!1,data:{url:t},type:"GET",url:WX_ROOT+"wechat/signature",beforSend:function(){common.alert({stayTime:-1})},success:function(t){if(t){var o=JSON.parse(t);luckyLottery.options.signature=o.signature,luckyLottery.options.nonceStr=o.nonceStr,luckyLottery.options.timestamp=o.timestamp,luckyLottery.options.appid=o.appid;var n=localStorage.getItem("userInfo");if(n&&"testUser"!=n){var r=JSON.parse(n);e="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+luckyLottery.options.appid+"&redirect_uri="+window.location.href.split("?")[0]+"&state="+r.mobile+"&response_type=code&scope=snsapi_base#wechat_redirect"}else e="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+luckyLottery.options.appid+"&redirect_uri="+window.location.href.split("?")[0]+"&response_type=code&scope=snsapi_base#wechat_redirect"}else common.tips({msg:"系统繁忙,获取signature失败!"})},complete:function(){common.alert({show:!1})}}),luckyLottery.share(luckyLottery.options.appid,luckyLottery.options.timestamp,luckyLottery.options.signature,luckyLottery.options.nonceStr,e)},share:function(e,t,o,n,r){wx.config({debug:!1,appId:e,timestamp:t,nonceStr:n,signature:o,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){var e="http://www.szqhflkj.cn/weixin/static/img/indexShare.jpg",t="买车险，找达农，Get您的私人车管家！",o="比价、投保、理赔、救援、专人专服，这么贴心还不约么~";wx.onMenuShareTimeline({title:t,link:r,imgUrl:e,success:function(){common.showId($(".shareSuccessfulTipSection")),common.saveShareRecord(t,o,r,e,1)}}),wx.onMenuShareAppMessage({title:t,desc:o,link:r,imgUrl:e,success:function(){common.showId($(".shareSuccessfulTipSection")),common.saveShareRecord(t,o,r,e,2)}})}),wx.error(function(e){common.tips({msg:"唉哟，分享出错了。亲重新试一次吧！",callback:function(){location.reload()}})})},bind:function(){$(".registerBtn").on("tap",function(){window.location.href=WX_ROOT+"base/regist"}),$(".inviteBtn").on("tap",function(){common.showId($(".shareSection"))}),$(".shareSection .morLayerDiv").on("tap",function(){common.close($(".shareSection"))}),$(".loginBtn").on("tap",function(){window.location.href=WX_ROOT+"base/login"});var e=common.getUrlParameter("state");e&&localStorage.setItem("inviteMobile",e);var t=localStorage.getItem("token");$(".btnDiv").on("tap",function(){t?window.location.href=WX_ROOT+"insurance/insureResult":common.showId($(".loginTipSection"))}),$(".arrowDiv1").on("tap",function(){t?luckyLottery.lottery(t):common.showId($(".loginTipSection"))}),$(".myrecord").on("tap",function(){var e=localStorage.getItem("token");e?window.location.href=WX_ROOT+"usercenter/myWinRecord":common.showId($(".loginTipSection"))}),$(".closeBtn").on("tap",function(){common.close($(".lotteryResultDiv")),common.close($(".loginTipSection"))}),$(".iKnowBtn").on("tap",function(){common.close($(".lotteryResultDiv"))})}};$(document).ready(function(){var e=localStorage.getItem(CLEAR_FLAG_KEY),t=localStorage.getItem("mobile"),o=localStorage.getItem("userInfo"),n=new Date(ENV_DATE).getTime();if(o&&!e){localStorage.clear(),sessionStorage.clear(),t&&localStorage.setItem("mobile",t);var r=common.getUrlParameter("state");r&&localStorage.setItem("inviteMobile",r),localStorage.setItem(CLEAR_FLAG_KEY,n),localStorage.setItem("userInfo","testUser"),luckyLottery.enterWxAuthor()}else localStorage.setItem(CLEAR_FLAG_KEY,n),luckyLottery.enterWxAuthor()});