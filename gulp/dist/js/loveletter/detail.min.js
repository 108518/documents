var detail={init:function(){$("article").show();var e=detail,t=JSON.parse(localStorage.getItem("wxUserInfo")).openid,a=common.getUrlParameter("loveId").split(",")[0];e.getDetail.send(t,a),e.author(),e.bind()},options:{signature:null,nonceStr:null,timestamp:null,appid:null,loveLetterImg:null,isOwner:0},enterWxAuthor:function(){var e=localStorage.getItem("wxUserInfo");if(e)detail.init();else{var t=common.getUrlParameter("code");t?(common.getWxUserInfo(),detail.init()):window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WX_APPID+"&redirect_uri="+window.location.href+"&response_type=code&scope=snsapi_userinfo#wechat_redirect"}},author:function(){var e,t=window.location.href.split("#")[0];detail.options.signature||$.ajax({async:!1,data:{url:t},type:"GET",url:WX_ROOT+"wechat/signature",beforSend:function(){common.alert({stayTime:-1})},success:function(t){if(t){var a=JSON.parse(t);detail.options.signature=a.signature,detail.options.nonceStr=a.nonceStr,detail.options.timestamp=a.timestamp,detail.options.appid=a.appid;var r=$(".letterMainDiv").attr("data-relation");e=window.location.href.split("?")[0]+"?loveId="+common.getUrlParameter("loveId").split(",")[0]+","+r}},complete:function(){common.alert({show:!1})}}),detail.share(detail.options.appid,detail.options.timestamp,detail.options.signature,detail.options.nonceStr,e)},share:function(e,t,a,r,o){wx.config({debug:!1,appId:e,timestamp:t,nonceStr:r,signature:a,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","chooseImage","previewImage","uploadImage","downloadImage"]}),wx.ready(function(){var e=$(".letterMainDiv"),t=(localStorage.getItem("wxUserInfo"),e.attr("data-toUser")),a=e.attr("data-fromuser");relation=e.attr("data-relation");var r="http://h5.sztoda.cn/static/img/love_letter_share_detail.png",n=a+"送给"+t+"的情书！拆开看看",i="哎哟，发现一封情书~";7==relation&&(t=t.indexOf("老师")>=0?t:t+"老师",n="感恩教师节，致"+t+"..",i="用岁月，编撰人生；用热情，浇灌花朵；用巫思，铸就精彩；用奉献，燃烧生命。教师节快乐！"),(new Date).getTime()/1e3<=1474127999&&(n="谨此中秋佳节之际，祝福送"+t+"..",i="皓月当空，月华流泻，满地如霜，中秋节快乐！",r="http://h5.sztoda.cn/static/img/Mid-autumn.png"),wx.onMenuShareTimeline({title:n,link:o,imgUrl:r,success:function(){common.saveShareRecord(n,i,o,r,1),$(".shareSection").addClass("dis_none")}}),wx.onMenuShareAppMessage({title:n,desc:i,link:o,imgUrl:r,success:function(){common.saveShareRecord(n,i,o,r,2),$(".shareSection").addClass("dis_none")}})}),wx.error(function(e){common.tips({msg:"获取授权证书失败！"})})},getDetail:{send:function(e,t){var a={};a.openid=e,a.loveId=t,$.ajax({async:!1,url:WX_CORS,beforSend:function(){common.alert({stayTime:-1})},data:{url:"rest/weixin/love/list",params:JSON.stringify(a)},type:"GET",success:function(e){if(e&&0==e.code){var t=e.data,a=t.toUser,r=t.fromUser,o=t.openid,n=t.createDate,i=t.relation,s=(new Date).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,l=(new Date).getDate()<10?"0"+(new Date).getDate():(new Date).getDate(),d=(new Date).getFullYear()+"-"+s+"-"+l,c=t.loveCheck,m=new Date(d).getTime()/1e3,p="",u=!1,h=!1,g=0,v=0,f=$(".dakaBtn"),w=$(".dakaNum"),S=$(".loveNum"),x=$(".dakaRestNum"),T=$(".getTicketBtn"),I=$(".teamDiv ul");if(c.length>0){for(var k=0;k<c.length;k++)1==c[k].type?(v++,u=new Date(c[k].checkTime).getTime()/1e3>=m):2==c[k].type&&(g++,h=c[k].friendOpenid==JSON.parse(localStorage.getItem("wxUserInfo")).openid,p+=" <li>",p+="<img src="+c[k].friendImg+' class="headImg">',p+=' <span class="sayText">'+c[k].wishText+"</span>",p+='<img src="../static/img/loveletter_heart1.png" class="zanImg">',p+="<span>  x1</span>",p+="</li>");u?f.addClass("hadDaka").removeClass("notDaka").text("今日已打卡").off():f.addClass("notDaka").removeClass("hadDaka").text("打卡"),0==g&&(p+="<p>还没有亲友团呢，赶紧分享吧</p>"),v+=parseInt(g/7),w.text(v),S.text(g),v>7?x.text(parseInt(7-v%7)):x.text(parseInt(7-v)),w.text()>=7&&(f.addClass("left-45"),T.show()),I.html(p)}else f.addClass("notDaka").removeClass("hadDaka").text("打卡"),$(".dakaNum,.loveNum").text(0),x.text(7),I.html('<p class="nonePerpel">还没有亲友团给你打卡呢，赶紧分享吧</p>');$(".letterMainDiv").attr("data-loveid",common.getUrlParameter("loveId").split(",")[0]).attr("data-loveOpenid",o).attr("data-fromUser",r).attr("data-toUser",a).attr("data-relation",i),$(".dakaTime").text(n),$(".toUser").text(a),$(".fromUser").text(r);var D=JSON.parse(localStorage.getItem("wxUserInfo")).openid;if(D.trim()===o.trim())detail.options.isOwner=1,$(".selfDiv").show(),$(".text-tips").show(),$(".imgDiv").on("tap",detail.uploadImage),$("#notDaka").on("tap",detail.daka),$(".again-write a").text("再写一封");else{var O=$(".otherDiv");O.show(),$(".love_shareBg").removeClass("dis_none"),h&&(O.html('<p class="me-too-play" id="meToPlay">我也要玩！</p><p class="help-share" id="meToPlay">帮他分享攒爱~</p>'),$("#meToPlay").off().on("tap",function(){window.location.href=WX_ROOT+"loveLetter/index"}),$(".help-share").on("tap",function(){$(".shareSection").removeClass("dis_none")})),$(".again-write a").text("我也要玩"),$("#friendDaka").on("tap",detail.daka)}e.data.loveText&&e.data.loveImg?($(".imgDiv img").prop("src",e.data.loveImg),$(".letterContent").text(e.data.loveText)):detail.randomLetter(e.data.loveText,e.data.loveImg);var _=parseInt($(".dakaNum").text());_&&$(".get-gift-p").show().on("tap",function(){window.location.href=WX_ROOT+"loveLetter/exchangeList"}),$("footer").show()}else common.error()},complete:function(){common.alert({show:!1})},timeout:3e3})}},randomLetter:function(e,t){$.getJSON(WX_STATIC+"json/qingshu.json",function(e){var t=$(".letterContent"),a=$(".imgDiv img"),r=null,o=$(".letterMainDiv").attr("data-relation");switch(parseInt(o)){case 1:arr=e.parents,r=WX_STATIC+"img/loveLetter/parents/parents"+(Math.round(30*Math.random())-1)+".jpg";break;case 2:arr=e.son,r=WX_STATIC+"img/loveLetter/children/children"+(Math.round(30*Math.random())-1)+".jpg";break;case 3:arr=e.lover,r=WX_STATIC+"img/loveLetter/lover/lover"+(Math.round(30*Math.random())-1)+".jpg";break;case 4:arr=e.friends,r=WX_STATIC+"img/loveLetter/friend/friend"+(Math.round(30*Math.random())-1)+".jpg";break;case 5:arr=e.friends,r=WX_STATIC+"img/loveLetter/friend/friend"+(Math.round(30*Math.random())-1)+".jpg";break;case 6:arr=e.oneself,r=WX_STATIC+"img/loveLetter/oneself/oneself"+(Math.round(30*Math.random())-1)+".jpg";break;case 7:arr=e.teacher,r=WX_STATIC+"img/loveLetter/teacher/teacher"+(Math.round(17*Math.random())-1)+".jpg";break;default:arr=e.lover,r=WX_STATIC+"img/loveLetter/lover/lover"+(Math.round(30*Math.random())-1)+".jpg"}t.html(arr[Math.round(Math.random()*arr.length)-1]||"生命这么浅，我们涉水而过，湿了 脚踝，丢了鞋子，到了对岸，如此 而已"),a.prop("src",r||WX_STATIC+"img/loveletter_title.png"),detail.updateLetter()})},updateLetter:function(){var e={};e.loveid=loveLetterId=$(".letterMainDiv").attr("data-loveid"),e.loveImg=detail.options.loveLetterImg||$(".imgDiv img").prop("src"),e.loveText=$(".letterContent").text(),$.ajax({url:WX_CORS,data:{url:"rest/weixin/love/update",params:JSON.stringify(e)},type:"POST",success:function(e){e&&e.code!=-1||common.error()},timeout:3e3})},daka:function(e){if($(".heart2323").addClass("loveletter_heart2"),"今日已打卡"!=$(e.currentTarget)[0].innerText){var t=$(".letterMainDiv").attr("data-loveid"),a=$(".letterMainDiv").attr("data-loveOpenid"),r=JSON.parse(localStorage.getItem("wxUserInfo")).openid,o="",n="",i="",s=1;r.trim()===a.trim()?s=1:(o=JSON.parse(localStorage.getItem("wxUserInfo")).headimgurl,$.ajax({async:!1,url:WX_STATIC+"json/wish.json",success:function(e){var t=$(".letterMainDiv").attr("data-relation");switch(parseInt(t)){case 1:arr=e.parents;break;case 2:arr=e.son;break;case 3:arr=e.lover;break;case 4:arr=e.friends;break;case 5:arr=e.friends;break;case 6:arr=e.oneself;break;case 7:arr=e.teacher;break;default:arr=e.friends}n=arr[Math.round(Math.random()*arr.length)-1]||"赞一个！"},timeout:3e3}),s=2,i+=" <li>",i+="<img src="+o+' class="headImg">',i+=' <span class="sayText">'+(n||"赞一个！")+"</span>",i+='<img src="../static/img/loveletter_heart1.png" class="zanImg">',i+="<span>  x1</span>",i+="</li>");var l={};l.friendOpenid=r,l.loveLetterId=t,l.friendImg=o,l.wishText=n,l.type=s,$.ajax({url:WX_CORS,data:{url:"rest/weixin/love/check",params:JSON.stringify(l)},type:"POST",success:function(e){if(e&&e.code!=-1){if(0==e.code){common.tips({msg:e.msg}),$(".dakaBtn").removeClass("notDaka").addClass("hadDaka").text("今日已打卡");var t=$(".dakaNum"),a=$(".dakaRestNum");$(".loveNum");t.html(parseInt(t.text())+1),parseInt(t.text())>7?a.html(7-t.text()%7):a.html(7-t.text());var r=$(".teamDiv ul");2==s&&r.children("p").remove(),r.append(i);var o=parseInt($(".dakaNum").text());o>=7&&($(".dakaBtn").addClass("left-45"),$(".getTicketBtn").show().on("tap",function(){window.location.href=WX_ROOT+"loveLetter/exchangeList"}))}else 8001==e.code&&common.tips({msg:e.msg});$(".otherDiv").html('<p class="me-too-play" id="meToPlay">我也要玩！</p><p class="help-share" id="meToPlay">帮他分享攒爱~</p>'),$("#meToPlay").off().on("tap",function(){window.location.href=WX_ROOT+"loveLetter/index"}),$(".help-share").on("tap",function(){$(".shareSection").removeClass("dis_none")})}else common.error()},timeout:3e3})}},uploadImage:function(e){wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(e){$(".imgDiv img").prop("src",e.localIds[0]),detail.uploadToWeixinServer(e.localIds[0],"loveLetter")}})},uploadToWeixinServer:function(e,t){wx.uploadImage({localId:e,isShowProgressTips:1,success:function(e){detail.uploadToOwnerServer(e.serverId,t)}})},uploadToOwnerServer:function(e,t){$.ajax({data:{serverId:e,type:t},type:"POST",url:WX_ROOT+"wechat/uploadPhoto",success:function(e){if(e){var t=JSON.parse(e.data);detail.options.loveLetterImg=t.path+t.name,detail.updateLetter()}}})},bind:function(){$(".shareBtn").on("tap",function(){$(".shareSection").removeClass("dis_none")}),$(".morLayerDiv").on("tap",function(){$(".shareSection").addClass("dis_none")}),$(".getTicketBtn").on("tap",function(){window.location.href=WX_ROOT+"loveLetter/exchangeList"})}};$(document).ready(function(){function e(e){var a=e.accelerationIncludingGravity,r=(new Date).getTime();if(r-n>100){var s=r-n;n=r,i=a.x,curShakeY=a.y,curShakeZ=a.z;var l=Math.abs(i+curShakeY+curShakeZ-lastShakeX-lastShakeY-lastShakeZ)/s*1e4;l>o&&(t.play(),detail.randomLetter()),lastShakeX=i,lastShakeY=curShakeY,lastShakeZ=curShakeZ}}if($("#playDirect").css("height",window.innerHeight),detail.enterWxAuthor(),window.DeviceMotionEvent&&1==detail.options.isOwner){var t=new Audio;t.src="../static/audio/7631.mp3";var a={preload:"auto"};for(var r in a)a.hasOwnProperty(r)&&r in t&&(t[r]=a[r]);window.addEventListener("devicemotion",e,!1)}var o=3e3,n=0,i=curShakeY=curShakeZ=lastShakeX=lastShakeY=lastShakeZ=0,s=document.createElement("audio");s.src="../static/audio/KissTheRain.mp3",s.play(),s.addEventListener("ended",function(){setTimeout(function(){s.play()},100)})});