<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta name="format-detection" content="telephone=no" >
        <link rel="stylesheet" type="text/css" href="/static/li/li-1.2.0.css">
        <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main.css"/>
    <title>附近的训练场</title>
    <style>
      .m-search {
        height: 10%;
      }
      .m-map {

      }
      .m-detail {
        height: 15%;
        background-color: white;
      }
      .el-detail-img {
        width: 100%;
        height: 0.8rem;
        background: url('/static/img/map/folder-up.png') no-repeat 50% 0;
        background-size: 100%;
        position: absolute;
        bottom: 15%;
        z-index: 999;
      }
      .el-txt-subtitle {
        font-weight: 400;
        font-size: 0.682rem;
      }

      #panel {
            position: fixed;
            background-color: white;
            max-height: 90%;
            overflow-y: auto;
            top: 10px;
            right: 10px;
            width: 280px;
        }
    </style>
    </head>
<body>
    <header></header>
    <article>
        <div class="li-init-loading" id="initLoading">
            <div class="li-initload-container li-initload-conone">
                <div class="li-initload-cirone"></div>
                <div class="li-initload-cirtwo"></div>
                <div class="li-initload-cirthree"></div>
                <div class="li-initload-cirfour"></div>
            </div>
            <div class="li-initload-container li-initload-contwo">
                <div class="li-initload-cirone"></div>
                <div class="li-initload-cirtwo"></div>
                <div class="li-initload-cirthree"></div>
                <div class="li-initload-cirfour"></div>
            </div>
            <div class="li-initload-container li-initload-conthree">
                <div class="li-initload-cirone"></div>
                <div class="li-initload-cirtwo"></div>
                <div class="li-initload-cirthree"></div>
                <div class="li-initload-cirfour"></div>
            </div>
        </div>
    </article>

<script type="text/html" id="indexTpl">
    <section class="m-main" style="height: <%= height + 'px' %>">
        <div class="weui-cells weui-cells_form m-search">
          <div class="weui-cell weui-cell_vcode">
            <div class="weui-cell__hd">
              <label class="weui-label">深圳市</label>
            </div>
            <div class="weui-cell__bd">
              <input class="weui-input" type="text" placeholder="请输入关键字搜索">
            </div>
            <div class="weui-cell__ft">
              <button class="weui-vcode-btn">搜索</button>
            </div>
          </div>
        </div>

        <div class="m-map" id="mapMain" tabindex="0" style="height: <%= height*0.75 + 'px' %>"></div>
        <div id="panel"></div>

        <div class="m-detail">
            <div class="el-detail-img">
              
            </div>
            <div class="el-detail-main li-pd-m">
              <p class="li-text-ellipsis">训练场</p>
              <div class="li-row li-align-center">
                  <div class="li-col-80 li-text-ellipsis li-txt-title li-txt-subtitle li-align-left">
                    深圳市福田区深南大道与香蜜湖度假村内部
                  </div>
                  <div class="li-col-20 el-txt-subtitle li-color-info" id="seeDetail">
                    详情 <i class="li-arrow li-arrow-right"></i>
                  </div>
              </div>

              <div class="li-row li-align-center li-pt-m">
                  <div class="li-col-50">
                    路线
                  </div>
                  <div class="li-col-50">
                    电话
                  </div>
              </div>
            </div>
        </div>

    </section>
</script>
<script src="/static/plugin/requirejs/require.min.js"></script>
<script type="text/javascript">
    var script = document.createElement("script"),
        head = document.head || document.getElementsByTagName('head')[0];

    script.type = "text/javascript";
    script.src = '/config.js?ver=' + (new Date()).getTime();

    head.appendChild(script); 

    script.onload = script.onreadystatechange = function() {
    require(
    [
      'jquery',
      'fastclick',
      'underscore',
      'common',
      'jqueryWeUI'
    ], function($, FastClick, _, START){
        FastClick.attach(document.body);

        var indexMain = {
            init: function(){
                this.renderHtml();
                this.renderComponent();
                this.watch(); 
            },
            //全局属性
            options: {
                
            },
            
            //渲染模板的数据
            data: {
                height: window.innerHeight
            },

            //渲染html
            renderHtml: function(){
                
            },
            //渲染组件
            renderComponent: function(){
                var self = this;
                
                $('article').html(_.template(indexTpl.innerHTML)(self.data))
                
                START.loadScript('http://webapi.amap.com/maps?v=1.3&key=fdce27a4cc7a66646d6c99571828778d',function(){
                  START.loadScript('http://cache.amap.com/lbs/static/addToolbar.js',function(){
                    var mapObj = new AMap.Map('mapMain');
                    var marker,driving;
                    mapObj.plugin('AMap.Geolocation', function () {
                        geolocation = new AMap.Geolocation({
                            enableHighAccuracy: true,//是否使用高精度定位，默认:true
                            timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                            maximumAge: 0,           //定位结果缓存0毫秒，默认：0
                            convert: true,           //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
                            showButton: true,        //显示定位按钮，默认：true
                            buttonPosition: 'LB',    //定位按钮停靠位置，默认：'LB'，左下角
                            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                            showMarker: true,        //定位成功后在定位到的位置显示点标记，默认：true
                            showCircle: true,        //定位成功后用圆圈表示定位精度范围，默认：true
                            panToLocation: true,     //定位成功后将定位到的位置作为地图中心点，默认：true
                            zoomToAccuracy:true      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                        });
                        mapObj.addControl(geolocation);
                        geolocation.getCurrentPosition(function(status,result){
                          mapObj = new AMap.Map('mapMain',{
                                resizeEnable: true,
                                zoom: 13,
                                center: result.position
                            });
                          
                          marker = new AMap.Marker({
                            position: result.position,
                            title: 'test',
                            clickable: true,
                            map: mapObj
                          });

                          marker.on('click',function(e){
                              infowindow.open(mapObj,e.target.getPosition());
                            })
                            AMap.plugin('AMap.AdvancedInfoWindow',function(){
                              var info = [];
                             info.push('<div style="background-color:white">');
                             info.push('<b>高德软件有限公司</b>');
                             info.push("电话 : 010-84107000   邮编 : 100102");
                             info.push("地址 : 北京市望京阜通东大街方恒国际中心A座16层</div>");

                               infowindow = new AMap.InfoWindow({
                               isCustom: true,  //使用自定义窗体
                                 content: info.join("<br>"),
                                 offset: new AMap.Pixel(0, -30)
                              });
                         });
                        });
                        AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
                        AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息

                        /*
                           * 调用公交换乘服务
                           */
                          //加载公交换乘插件
                          AMap.service(["AMap.Transfer"], function() {
                              var transOptions = {
                                  map: mapObj,
                                  city: '深圳市',
                                  policy: AMap.TransferPolicy.LEAST_TIME //乘车策略
                              };
                              //构造公交换乘类
                              var trans = new AMap.Transfer(transOptions);
                              //根据起、终点坐标查询公交换乘路线
                              trans.search([{keyword:'大新'},{keyword:'坪洲'}], function(status, result){
                              });
                          });
                          START.loadScript('https://webapi.amap.com/demos/js/liteToolbar.js')
                    });
                  });
                })
            },

            watch: function(){
                $(document).on('click','#seeDetail', function(){
                    window.location.href = '/map/detail.html?id=1'
                })
            }
            
        } 
        indexMain.init();
    })
  }
</script>

<style type="text/css">
  .weui-cells {
    margin: 0;
  }
  .li-arrow {
      border-color: #10aeff;
  }
</style>
</body>
</html>